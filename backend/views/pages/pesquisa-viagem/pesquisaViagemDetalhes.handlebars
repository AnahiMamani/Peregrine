{{> headerUsuario}}

<main>
    <div class="row">
        <div class="col">
            &nbsp;
        </div>
    </div>
    <div class="row">
        <div class="col">
            &nbsp;
        </div>
    </div>

    <form class="container">
        <div class="row">
            <div class="col">
                &nbsp;
            </div>
        </div>
        <div id="perfilCompletoOrganizadora" name="perfilCompletoOrganizadora"
            class="card-body d-flex align-items-center justify-content-end" style="margin-left: 48vw;">
            <!-- Texto da organizadora -->
            <div class="my-2 text-end">
                <h4 id="nomeOrganizadora" name="nomeOrganizadora"
                    style="color: #99067E; font-weight: bold; cursor: pointer;">
                    Organizadora: {{#if viagem.A02_APELIDO}}
                    {{viagem.A02_APELIDO}}
                    {{else}}
                    {{viagem.A02_NOME}}
                    {{/if}}
                </h4>
                <p id="avaliacaoOrganizadora" name="avaliacaoOrganizadora" style="font-size: 1.2rem; color: #6c757d;">
                    <span style="color: #99067E;">★</span> {{viagem.A02_NOTA}}
                </p>
            </div>

            <!-- Imagem de perfil -->
            <img id="perfilOrganizadora" name="perfilOrganizadora"
                src="/uploads/{{viagem.A03_ORGANIZADORA}}/perfil/perfil.jpg" alt="Foto de Perfil"
                class="rounded-circle border border-3 border-light"
                style="cursor: pointer; width: 150px; height: 150px; object-fit: cover; margin-left: 20px;">
        </div>

        <div class="row">
            <div class="col">
                &nbsp;
            </div>
        </div>

        <div class="row text-center">
            <h1 class="border-0 fs-1 text-center rounded-4">
                {{viagem.A03_TITULO}}
            </h1>
            <h5 class="my-4 container text-center border-secondary" style="height: 1rem;">
                {{viagem.A03_SUBTITULO}}
            </h5>
        </div>
        <!-- espaço para inserção das principais informações da viagem -->
        <div class="row my-4 container text-center rounded-4 border border-2 border-secondary" style="width: 90vw;">
            <div class="container my-4">
                <!-- Linha contendo as 4 colunas -->
                <div class="row justify-content-center">
                    <!-- Primeira coluna - Origem -->
                    <div class="col-12 col-md-3 p-4 my-4 d-flex flex-column align-items-center">
                        <div class="d-flex align-items-center mb-2">
                            <img src="/images/icon-origem-localizacao.png" alt="Ícone de localização"
                                style="width: 1.5rem; height: 1.5rem; margin-right: 0.5rem;">
                            <h4 class="m-0">Origem</h4>
                        </div>
                        <p type="text" name="origemViagem" id="origemViagem" class="form-control text-center rounded-4"
                            style="height: 2.5rem;">{{viagem.A03_ORIGEM}}</p>
                    </div>

                    <!-- Segunda coluna - Destino -->
                    <div class="col-12 col-md-3 p-4 my-4 d-flex flex-column align-items-center">
                        <div class="d-flex align-items-center mb-2">
                            <img src="/images/icon-destino-mundo.png" alt="Ícone de mundo - localização"
                                style="width: 1.5rem; height: 1.5rem; margin-right: 0.5rem;">
                            <h4 class="m-0">Destino</h4>
                        </div>
                        <p type="text" name="destinoViagem" id="destinoViagem" placeholder="Para onde você vai?"
                            class="form-control text-center rounded-4" style="height: 2.5rem;">{{viagem.A03_DESTINO}}
                        </p>
                    </div>

                    <!-- Terceira coluna - Vagas -->
                    <div class="col-12 col-md-3 p-4 my-4 d-flex flex-column align-items-center">
                        <div class="d-flex align-items-center mb-2">
                            <img src="/images/icon-perfilPreto.png" alt="Ícone de mulher - pessoa"
                                style="width: 1.5rem; height: 1.5rem; margin-right: 0.5rem;">
                            <h4 class="m-0">Vagas</h4>
                        </div>
                        <p type="number" name="vagasViagem" id="vagasViagem" placeholder="Total de vagas oferecidas"
                            class="form-control text-center rounded-4" style="height: 2.5rem;">{{viagem.A03_VAGAS}}</p>
                    </div>

                    <!-- Quarta coluna - Custo -->
                    <div class="col-12 col-md-3 p-4 my-4 d-flex flex-column align-items-center">
                        <div class="d-flex align-items-center mb-2">
                            <img src="/images/icon-dinheiro.png" alt="Ícone de dinheiro"
                                style="width: 1.5rem; height: 1.5rem; margin-right: 0.5rem;">
                            <h4 class="m-0">Custo estimado</h4>
                        </div>
                        <p type="number" name="custoViagem" id="custoViagem" placeholder="Valor para cada uma"
                            class="form-control text-center rounded-4" style="height: 2.5rem;">{{viagem.A03_CUSTO}}</p>
                    </div>
                </div>

                <!-- Campo para o período de viagem -->
                <div class="row justify-content-center">
                    <!-- Campo de ida e volta -->
                    <div class="col-12 col-md-6 p-4 my-4">
                        <div class="d-flex align-items-center justify-content-center px-2 mb-2">
                            <h4 class="m-0 me-5">Ida</h4>
                            <div class="d-flex align-items-center" style="margin-left: 130px;">
                                <h4 class="m-0">Embarque</h4>
                                <img src="/images/icon-data.png" alt="Ícone de data - calendário" class="mx-2"
                                    style="width: 1.5rem; height: 1.5rem;">
                                <h4 class="m-0">Horário</h4>
                            </div>
                        </div>
                        <div class="input-group">
                            <p id="localIdaViagem" class="form-control text-center rounded-start-4"
                                style="height: 2.5rem; flex: 2;">{{viagem.A03_LOCAL_IDA}}</p>
                            <p id="dataIdaViagem" class="form-control text-center" style="height: 2.5rem; flex: 1;">
                                {{viagem.A03_DATA_IDA}}</p>
                            <p id="horaIdaViagem" class="form-control text-center rounded-end-4"
                                style="height: 2.5rem; flex: 1;">{{viagem.A03_HORA_IDA}}</p>
                        </div>
                    </div>

                    <!-- Campo de volta -->
                    <div class="col-12 col-md-6 p-4 my-4">
                        <div class="d-flex align-items-center justify-content-center px-2 mb-2">
                            <h4 class="m-0 me-5">Volta</h4>
                            <div class="d-flex align-items-center" style="margin-left: 100px;">
                                <h4 class="m-0">Embarque</h4>
                                <img src="/images/icon-data.png" alt="Ícone de data - calendário" class="mx-2"
                                    style="width: 1.5rem; height: 1.5rem;">
                                <h4 class="m-0">Horário</h4>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-group">
                                <p id="localIdaViagem" class="form-control text-center rounded-start-4"
                                    style="height: 2.5rem; flex: 2;">{{viagem.A03_LOCAL_VOLTA}}</p>
                                <p id="dataIdaViagem" class="form-control text-center" style="height: 2.5rem; flex: 1;">
                                    {{viagem.A03_DATA_VOLTA}}</p>
                                <p id="horaIdaViagem" class="form-control text-center rounded-end-4"
                                    style="height: 2.5rem; flex: 1;">{{viagem.A03_HORA_VOLTA}}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- espaço para inserção do texto descritivo da viagem -->
        <p name="descricaoViagem" id="descricaoViagem"
            placeholder="Descreva como a sua viagem será fantástica, os roteiros previstos, informações sobre passeios turísticos, cultura do local, gastronomia..."
            class="my-4 container" style="width: 80vw; padding: 2rem; text-align: justify;">
            {{viagem.A03_DESCRICAO}}
        </p>

        <div class="row">
            <div class="col">
                &nbsp;
            </div>
        </div>
        <div class="row">
            <div class="col">
                &nbsp;
            </div>
        </div>

        <!-- o botão abaixo abre uma janela no js para confirmação da inscrição na viagem-->
        <div class="d-flex align-items-center justify-content-center">
            <button id="confirmaInscreverViagem" data-viagem-id="{{viagem.A03_ID}}" class="btn btn-primary"
                type="button">
                Inscrever-se
            </button>
        </div>
    </form>
    <div class="row">
        <div class="col">
            &nbsp;
        </div>
    </div>
    <div class="row">
        <div class="col">
            &nbsp;
        </div>
    </div>

</main>
{{> footer }}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btnPerfilOrganizadora = document.getElementById('perfilCompletoOrganizadora');

        btnPerfilOrganizadora.addEventListener('click', () => {
            // Cria a estrutura HTML da janela de confirmação
            const overlay = document.createElement('div');
            overlay.id = 'confirmOverlay';
            overlay.className = 'confirm-overlay';
            overlay.innerHTML = `
            <div class="card-body confirm-box">
                <img id="perfilOrganizadora" name="perfilOrganizadora" src="/uploads/{{viagem.A03_ORGANIZADORA}}/perfil/perfil.jpg" alt="Foto de Perfil" class="rounded-circle border border-3 border-light" style="cursor:pointer; width: 150px; height: 150px; object-fit: cover; margin-right: 20px;">
                <div class="my-2">
                    <h4 class="text-center" style="font-weight: bold;">
                    {{#if viagem.A02_APELIDO}}
                    {{viagem.A02_APELIDO}}
                    {{else}}
                    {{viagem.A02_NOME}}
                    {{/if}}
                    </h4>
                    <p class="text-center" style="font-size: 1.2rem; color: #6c757d;">
                        <span style="color: #99067E;">★</span>{{viagem.A02_NOTA}}
                    </p>
                </div>
                <p class="text-justify">{{viagem.A02_DESCRICAO}}</p>
                <button class="btn btn-primary btn-confirmar-entendi w-50">Ok, entendi!</button>

            </div>
        `;
        // Fecha a janela ao clicar no botão "Ok,entendi"
        overlay.querySelector('.btn-confirmar-entendi').addEventListener('click', () => {
            document.body.removeChild(overlay);
        });

            // Adiciona a janela ao body
            document.body.appendChild(overlay);

            // Fecha a janela ao clicar fora do modal
            overlay.addEventListener('click', (event) => {
                // Verifica se o clique foi fora do conteúdo do modal
                if (event.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const btnInscreverViagem = document.getElementById('confirmaInscreverViagem');

        btnInscreverViagem.addEventListener('click', (event) => {
            event.preventDefault(); // Previne o comportamento padrão do botão

            // Cria a estrutura do modal de confirmação
            const overlay = document.createElement('div');
            overlay.id = 'confirmOverlay';
            overlay.className = 'confirm-overlay';
            overlay.innerHTML = `
            <div class="confirm-box">
                <h4>Você confirma sua inscrição nessa viagem?</h4>
                <p>Ao concordar, você será direcionado para o grupo externo da viagem (moderado e sob responsabilidade da organizadora, sem intervenção do Peregrine)</p>
                <div class="confirm-buttons">
                    <button class="btn btn-secondary btn-confirmar-nao">Não, quero voltar</button>
                    <button class="btn btn-primary btn-confirmar-sim">Sim, partiu viajar!</button>
                </div>
            </div>
        `;

            // Adiciona a janela ao body
            document.body.appendChild(overlay);

            // Fecha o modal ao clicar em "Não, quero voltar"
            overlay.querySelector('.btn-confirmar-nao').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });

            // Redireciona ao backend para adicionar a viagem ao clicar em "Sim, partiu viajar!"
            overlay.querySelector('.btn-confirmar-sim').addEventListener('click', async () => {
                const viagemId = btnInscreverViagem.dataset.viagemId; // Obter o ID da viagem do botão

                try {
                    const response = await fetch(`/control/adicionar/${viagemId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });

                    if (response.ok) {
                        window.location.href = `/viagem/inscricao/{{viagem.A03_ID}}`; // Redireciona ao concluir com sucesso
                    } else {
                        const errorData = await response.json();

                        // Verifique se o erro é relacionado à duplicação de inscrição
                        if (errorData.message && errorData.message.includes('Duplicate entry')) {
                            // Modal para erro de chave duplicada (já inscrito na viagem)
                            overlay.querySelector('.confirm-box').innerHTML = `
                            <h4>Ops! Acho que você já se inscreveu nesta viagem!</h4>
                            <p>Por favor, verifique suas viagens inscritas.</p>
                            <div class="confirm-buttons">
                                <button class="btn btn-secondary btn-voltar2 btn-confirmar-nao">Voltar</button>
                                <a href="/perfil/minhas-viagens-inscritas" class="btn btn-secondary btn-confirmar-sim">Minhas viagens inscritas</a>
                            </div>
                        `;

                            // Fecha o modal ao clicar no botão "Voltar"
                            overlay.querySelector('.btn-voltar2').addEventListener('click', () => {
                                document.body.removeChild(overlay);
                            });
                        } else {
                            // Para qualquer outro erro, renderiza o modal de erro genérico de duplicação
                            overlay.querySelector('.confirm-box').innerHTML = `
                            <h4>Ops! Acho que você já se inscreveu nesta viagem!</h4>
                            <p>${errorData.message || 'Tente novamente.'}</p>
                            <div class="confirm-buttons">
                                <button class="btn btn-secondary btn-voltar2 btn-confirmar-nao">Voltar</button>
                                <a href="/perfil/minhas-viagens-inscritas" class="btn btn-secondary btn-confirmar-sim">Minhas viagens inscritas</a>
                            </div>
                        `;

                            // Fecha o modal ao clicar no botão "Voltar"
                            overlay.querySelector('.btn-voltar2').addEventListener('click', () => {
                                document.body.removeChild(overlay);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Erro ao tentar inscrever-se:', error);
                    // Renderiza o modal genérico de erro, caso ocorra qualquer outro erro
                    overlay.querySelector('.confirm-box').innerHTML = `
                    <h4>Ops! Acho que você já se inscreveu nesta viagem!</h4>
                    <p>Por favor, tente novamente mais tarde.</p>
                    <div class="confirm-buttons">
                        <button class="btn btn-secondary btn-voltar2 btn-confirmar-nao">Voltar</button>
                        <a href="/perfil/minhas-viagens-inscritas" class="btn btn-secondary btn-confirmar-sim">Minhas viagens inscritas</a>
                    </div>
                `;

                    // Fecha o modal ao clicar no botão "Voltar"
                    overlay.querySelector('.btn-voltar2').addEventListener('click', () => {
                        document.body.removeChild(overlay);
                    });
                }
            });
        });
    });


</script>